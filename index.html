<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ev Gider Paneli</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (JSX için) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        /* iOS Safari'de tam ekran hissi için */
        input, select { font-size: 16px; } 
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

<div id="root"></div>

<!-- Uygulama Kodu -->
<script type="text/babel">
    // --- ÖNEMLİ: FIREBASE AYARLARI ---
    // GitHub'da çalışması için kendi Firebase proje ayarlarınızı buraya girmelisiniz.
    // console.firebase.google.com adresinden yeni proje oluşturup alabilirsiniz.
    const firebaseConfig = {
  apiKey: "AIzaSyCAVUZ_JqgKUSz9bsNuYcqZpxeb5oeQZhc",
  authDomain: "ortak-ev.firebaseapp.com",
  projectId: "ortak-ev",
  storageBucket: "ortak-ev.firebasestorage.app",
  messagingSenderId: "155397684368",
  appId: "1:155397684368:web:d37e5f20a8eebf6b166c15",
  measurementId: "G-T3XRGZ6H9B"
    };

    // Firebase SDK'larını CDN'den yüklüyoruz (Modül kullanımı yerine global)
    // Not: Gerçek bir projede import kullanmak daha iyidir ama tek dosya için bu yöntem en kolayıdır.
</script>

<!-- Firebase Kütüphaneleri -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // React Component
    const { useState, useEffect } = React;
    const { Plus, Trash2, Wallet, Calendar, Calculator, CheckCircle, AlertCircle, Loader2 } = lucide;

    function App() {
        // --- Firebase Init ---
        // Not: Config yukarıdaki script tag'inden gelmeli veya buraya direkt yazılmalı
        // Hızlı çözüm için config'i buraya manuel yazın:
        const myConfig = {
             // BURAYA KENDİ CONFIG BİLGİLERİNİZİ YAPIŞTIRIN
             // apiKey: "...",
        };
        
        // Eğer config boşsa uyarı ver
        if (!myConfig.apiKey) {
            return (
                <div className="p-10 text-center">
                    <h1 className="text-red-600 font-bold">Firebase Ayarları Eksik</h1>
                    <p>Lütfen index.html dosyasını açıp <code>myConfig</code> kısmına kendi Firebase bilgilerinizi girin.</p>
                </div>
            );
        }

        const app = initializeApp(myConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const [user, setUser] = useState(null);
        const [expenses, setExpenses] = useState([]);
        const [loading, setLoading] = useState(true);
        const [description, setDescription] = useState('');
        const [amount, setAmount] = useState('');
        const [payer, setPayer] = useState('Cihan');
        const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
        const [isSettlementDay, setIsSettlementDay] = useState(false);

        useEffect(() => {
            signInAnonymously(auth).catch(console.error);
            const unsubscribe = onAuthStateChanged(auth, setUser);
            return () => unsubscribe();
        }, []);

        useEffect(() => {
            if (!user) return;
            // Kendi projenizde koleksiyon adı basit olabilir
            const q = query(collection(db, 'houseExpenses'), orderBy('dateIso', 'desc'));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setExpenses(data);
                setLoading(false);
            });
            return () => unsubscribe();
        }, [user]);

        useEffect(() => {
            if (new Date().getDate() === 21) setIsSettlementDay(true);
        }, []);

        const handleAdd = async (e) => {
            e.preventDefault();
            if (!description || !amount) return;
            
            const dateObj = new Date(selectedDate);
            
            await addDoc(collection(db, 'houseExpenses'), {
                description,
                amount: parseFloat(amount),
                payer,
                date: dateObj.toLocaleDateString('tr-TR'),
                dateIso: selectedDate,
                createdAt: Date.now()
            });
            setDescription('');
            setAmount('');
            setSelectedDate(new Date().toISOString().split('T')[0]);
        };

        const handleDelete = async (id) => {
            await deleteDoc(doc(db, 'houseExpenses', id));
        };

        // Hesaplamalar
        const totalCihan = expenses.filter(e => e.payer === 'Cihan').reduce((acc, curr) => acc + curr.amount, 0);
        const totalBayram = expenses.filter(e => e.payer === 'Bayram').reduce((acc, curr) => acc + curr.amount, 0);
        const totalHouse = totalCihan + totalBayram;
        const sharePerPerson = totalHouse / 2;
        
        let statusMessage = "";
        let debtAmount = 0;
        let debtor = "", creditor = "";

        if (totalCihan > totalBayram) {
            debtAmount = totalCihan - sharePerPerson;
            debtor = "Bayram"; creditor = "Cihan";
        } else if (totalBayram > totalCihan) {
            debtAmount = totalBayram - sharePerPerson;
            debtor = "Cihan"; creditor = "Bayram";
        }

        const fmt = (v) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(v);

        if (loading) return <div className="flex h-screen items-center justify-center text-slate-500">Yükleniyor...</div>;

        return (
            <div className="max-w-md mx-auto p-4 space-y-6">
                <div className="bg-white rounded-2xl shadow-lg p-6 text-center border-b-4 border-blue-500">
                    <h1 className="text-2xl font-bold flex justify-center gap-2 items-center text-slate-800">
                        <i data-lucide="wallet" className="text-blue-500"></i> Ev Giderleri
                    </h1>
                </div>

                {isSettlementDay && (
                    <div className="bg-red-50 border border-red-200 rounded-xl p-4 text-red-700 animate-pulse">
                        <strong>Dikkat:</strong> Bugün hesap günü (Ayın 21'i)!
                    </div>
                )}

                <div className="bg-white rounded-2xl shadow p-4">
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="p-3 bg-slate-50 rounded border border-slate-100">
                            <div className="text-xs text-slate-500">Cihan</div>
                            <div className="font-bold">{fmt(totalCihan)}</div>
                        </div>
                        <div className="p-3 bg-slate-50 rounded border border-slate-100">
                            <div className="text-xs text-slate-500">Bayram</div>
                            <div className="font-bold">{fmt(totalBayram)}</div>
                        </div>
                    </div>
                    <div className="bg-slate-800 text-white p-4 rounded-xl">
                         {debtAmount > 0.1 ? (
                            <div>
                                <div className="text-xs text-slate-400">Ödenmesi Gereken</div>
                                <div className="font-bold text-orange-400 text-lg">
                                    {debtor} ➔ {creditor}: {fmt(debtAmount)}
                                </div>
                            </div>
                         ) : <div className="text-green-400 font-bold">Borç Yok!</div>}
                    </div>
                </div>

                <form onSubmit={handleAdd} className="bg-white rounded-2xl shadow p-4 space-y-3">
                    <input type="text" placeholder="Harcama adı" value={description} onChange={e=>setDescription(e.target.value)} className="w-full p-3 border rounded-lg" />
                    <div className="flex gap-2">
                        <input type="number" placeholder="Tutar" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full p-3 border rounded-lg" />
                        <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full p-3 border rounded-lg" />
                    </div>
                    <select value={payer} onChange={e=>setPayer(e.target.value)} className="w-full p-3 border rounded-lg bg-white">
                        <option value="Cihan">Cihan</option>
                        <option value="Bayram">Bayram</option>
                    </select>
                    <button className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">Ekle</button>
                </form>

                <div className="space-y-2">
                    {expenses.map(ex => (
                        <div key={ex.id} className="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-slate-50">
                            <div>
                                <div className="font-bold">{ex.description}</div>
                                <div className="text-xs text-slate-500">{ex.date} • {ex.payer}</div>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="font-bold">{fmt(ex.amount)}</span>
                                <button onClick={()=>handleDelete(ex.id)} className="text-red-300 hover:text-red-500"><i data-lucide="trash-2"></i></button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    
    // İkonları oluştur
    setTimeout(() => lucide.createIcons(), 100);
</script>
</body>
</html>
