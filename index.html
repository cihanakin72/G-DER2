<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ev Gider Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- React 17 (Daha Stabil CDN) -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-100">

<!-- Y√ºkleme ve Hata Ekranƒ± -->
<div id="status-box" style="padding: 20px; text-align: center; margin-top: 50px;">
    <h2 style="font-size: 24px; color: #64748b;">Uygulama Y√ºkleniyor...</h2>
    <p style="color: #94a3b8;">L√ºtfen bekleyin, baƒülantƒ± kuruluyor.</p>
    <div id="error-message" style="color: red; margin-top: 20px; font-weight: bold; display: none;"></div>
</div>

<div id="root" style="display: none;"></div>

<script>
    // Global Hata Yakalayƒ±cƒ±
    window.onerror = function(msg, url, line) {
        document.getElementById('status-box').style.display = 'block';
        document.getElementById('root').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-message').innerHTML = 'HATA: ' + msg + '<br>Satƒ±r: ' + line;
    };
</script>

<script type="text/babel">
    try {
        // --- AYARLAR ---
        const firebaseConfig = {
            apiKey: "AIzaSyCAVUZ_JqgKUSz9bsNuYcqZpxeb5oeQZhc",
            authDomain: "ortak-ev.firebaseapp.com",
            projectId: "ortak-ev",
            storageBucket: "ortak-ev.firebasestorage.app",
            messagingSenderId: "155397684368",
            appId: "1:155397684368:web:d37e5f20a8eebf6b166c15",
            measurementId: "G-T3XRGZ6H9B"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [payer, setPayer] = useState('Cihan');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [settlement, setSettlement] = useState(false);

            useEffect(() => {
                auth.signInAnonymously().catch(e => alert("Giri≈ü Hatasƒ±: " + e.message));
                return auth.onAuthStateChanged(u => setUser(u));
            }, []);

            useEffect(() => {
                if(!user) return;
                const unsub = db.collection('houseExpenses').orderBy('dateIso', 'desc').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setExpenses(data);
                    setLoading(false);
                    // Y√ºkleme ekranƒ±nƒ± gizle, uygulamayƒ± g√∂ster
                    document.getElementById('status-box').style.display = 'none';
                    document.getElementById('root').style.display = 'block';
                }, err => {
                    alert("Veri Okuma Hatasƒ±: " + err.message);
                });
                return () => unsub();
            }, [user]);
            
            useEffect(() => {
                if(new Date().getDate() === 21) setSettlement(true);
            }, []);

            const addExpense = async (e) => {
                e.preventDefault();
                if(!description || !amount) return;
                try {
                    await db.collection('houseExpenses').add({
                        description,
                        amount: parseFloat(amount),
                        payer,
                        date: new Date(selectedDate).toLocaleDateString('tr-TR'),
                        dateIso: selectedDate,
                        createdAt: Date.now()
                    });
                    setDescription('');
                    setAmount('');
                } catch(e) { alert("Ekleme Hatasƒ±: " + e.message); }
            };

            const deleteExpense = async (id) => {
                if(confirm('Silinsin mi?')) await db.collection('houseExpenses').doc(id).delete();
            };

            // Hesaplamalar
            const cihanTotal = expenses.filter(e => e.payer === 'Cihan').reduce((a, b) => a + b.amount, 0);
            const bayramTotal = expenses.filter(e => e.payer === 'Bayram').reduce((a, b) => a + b.amount, 0);
            const total = cihanTotal + bayramTotal;
            const diff = (cihanTotal - bayramTotal) / 2;
            
            const fmt = (n) => new Intl.NumberFormat('tr-TR', {style:'currency', currency:'TRY'}).format(n);

            return (
                <div className="max-w-md mx-auto p-4 pb-20 space-y-4 font-sans text-slate-800">
                    <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
                        <h1 className="text-2xl font-bold flex items-center gap-2">üè† Ev Giderleri <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Online</span></h1>
                    </div>

                    {settlement && <div className="bg-red-100 text-red-800 p-4 rounded-xl font-bold border border-red-300">‚ö†Ô∏è Bug√ºn Hesap G√ºn√º (Ayƒ±n 21'i)!</div>}

                    <div className="bg-white p-4 rounded-xl shadow space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-slate-50 p-3 rounded border">
                                <div className="text-xs text-slate-500">Cihan</div>
                                <div className="text-xl font-bold">{fmt(cihanTotal)}</div>
                            </div>
                            <div className="bg-slate-50 p-3 rounded border">
                                <div className="text-xs text-slate-500">Bayram</div>
                                <div className="text-xl font-bold">{fmt(bayramTotal)}</div>
                            </div>
                        </div>
                        <div className="bg-slate-800 text-white p-4 rounded-xl">
                            {diff > 0 ? 
                                <div><div className="text-xs opacity-70">√ñdenmesi Gereken</div><div className="text-lg font-bold text-orange-400">Bayram ‚ûî Cihan: {fmt(diff)}</div></div> :
                             diff < 0 ?
                                <div><div className="text-xs opacity-70">√ñdenmesi Gereken</div><div className="text-lg font-bold text-orange-400">Cihan ‚ûî Bayram: {fmt(Math.abs(diff))}</div></div> :
                                <div className="text-green-400 font-bold">‚úÖ Bor√ß Yok, E≈üit!</div>
                            }
                        </div>
                    </div>

                    <form onSubmit={addExpense} className="bg-white p-4 rounded-xl shadow space-y-3">
                        <h3 className="font-bold text-sm">Harcama Ekle</h3>
                        <input type="text" placeholder="Ne aldƒ±n?" value={description} onChange={e=>setDescription(e.target.value)} className="w-full p-3 border rounded-lg" />
                        <div className="flex gap-2">
                            <input type="number" placeholder="0.00" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full p-3 border rounded-lg" />
                            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full p-3 border rounded-lg" />
                        </div>
                        <select value={payer} onChange={e=>setPayer(e.target.value)} className="w-full p-3 border rounded-lg bg-white">
                            <option value="Cihan">Cihan √ñdedi</option>
                            <option value="Bayram">Bayram √ñdedi</option>
                        </select>
                        <button className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">‚ûï Ekle</button>
                    </form>

                    <div className="space-y-2">
                        <h3 className="font-bold text-sm px-1">Ge√ßmi≈ü</h3>
                        {expenses.map(ex => (
                            <div key={ex.id} className="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-slate-50">
                                <div>
                                    <div className="font-bold">{ex.description}</div>
                                    <div className="text-xs text-slate-500">{ex.date} ‚Ä¢ {ex.payer}</div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-bold">{fmt(ex.amount)}</span>
                                    <button onClick={()=>deleteExpense(ex.id)} className="text-red-300 hover:text-red-600">üóëÔ∏è</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));

    } catch (err) {
        document.getElementById('status-box').style.display = 'block';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-message').innerHTML = 'REACT HATASI: ' + err.message;
    }
</script>

</body>
</html>
