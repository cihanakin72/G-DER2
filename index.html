<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ev Gider Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- K√úT√úPHANELER -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-100">

<!-- Y√úKLEME EKRANI -->
<div id="status-box" style="padding: 40px; text-align: center; margin-top: 50px;">
    <h2 style="font-size: 24px; color: #64748b; font-family: sans-serif;">Uygulama Y√ºkleniyor...</h2>
    <div id="error-message" style="color: white; background: red; padding: 15px; margin-top: 20px; font-weight: bold; border-radius: 8px; display: none;"></div>
</div>

<div id="root" style="display: none;"></div>

<script>
    window.onerror = function(msg, url, line) {
        document.getElementById('status-box').style.display = 'block';
        document.getElementById('root').style.display = 'none';
        var errBox = document.getElementById('error-message');
        errBox.style.display = 'block';
        errBox.innerHTML = 'B√úY√úK HATA: ' + msg + '<br>Satƒ±r: ' + line;
    };
</script>

<script type="text/babel">
    try {
        // --- AYARLAR ---
        const firebaseConfig = {
            apiKey: "AIzaSyCAVUZ_JqgKUSz9bsNuYcqZpxeb5oeQZhc",
            authDomain: "ortak-ev.firebaseapp.com",
            projectId: "ortak-ev",
            storageBucket: "ortak-ev.firebasestorage.app",
            messagingSenderId: "155397684368",
            appId: "1:155397684368:web:d37e5f20a8eebf6b166c15",
            measurementId: "G-T3XRGZ6H9B"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { useState, useEffect } = React;

        const DEFAULT_TAGS = ["A-101", "Bim", "Migros", "File", "≈ûok", "Kafe", "Market", "Su", "Kira", "Aidat", "Fatura", "Ekmek", "Pazar", "Diƒüer"];

        // D√ñNEM HESAPLAMA (22'sinden 21'ine)
        function getPeriodRange(dateObj) {
            let year = dateObj.getFullYear();
            let month = dateObj.getMonth();
            let day = dateObj.getDate();
            let start, end, label;

            if (day > 21) {
                start = new Date(year, month, 22);
                end = new Date(year, month + 1, 21, 23, 59, 59);
                let nextMonthName = new Date(year, month + 1, 1).toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                label = nextMonthName + " D√∂nemi";
            } else {
                start = new Date(year, month - 1, 22);
                end = new Date(year, month, 21, 23, 59, 59);
                let currentMonthName = new Date(year, month, 1).toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                label = currentMonthName + " D√∂nemi";
            }
            return { start, end, label };
        }

        function App() {
            // --- STATE ---
            const [user, setUser] = useState(null);
            const [sessionName, setSessionName] = useState(localStorage.getItem('deviceUser') || '');
            const [showLogin, setShowLogin] = useState(!localStorage.getItem('deviceUser'));
            
            const [allExpenses, setAllExpenses] = useState([]);
            const [logs, setLogs] = useState([]);
            const [customTags, setCustomTags] = useState([]);
            
            // G√∂r√ºn√ºm State'leri
            const [view, setView] = useState('main'); // 'main', 'logs', 'yearly'
            
            // Form State'leri
            const [category, setCategory] = useState('Diƒüer'); // Se√ßilen Kategori
            const [description, setDescription] = useState(''); // Yazƒ±lan A√ßƒ±klama
            const [amount, setAmount] = useState('');
            const [payer, setPayer] = useState('Cihan');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            
            // Filtreleme State'leri
            const [viewDate, setViewDate] = useState(new Date()); 
            const [filterUser, setFilterUser] = useState('HEPSI');
            const [filterCategories, setFilterCategories] = useState([]); // √áoklu se√ßim i√ßin array

            // Auth
            useEffect(() => {
                auth.signInAnonymously().catch(e => alert(e.message));
                return auth.onAuthStateChanged(u => setUser(u));
            }, []);

            // Veri Dinleme
            useEffect(() => {
                if(!user) return;
                
                const unsubExp = db.collection('houseExpenses').orderBy('dateIso', 'desc').onSnapshot(snap => {
                    setAllExpenses(snap.docs.map(d => ({id: d.id, ...d.data()})));
                    document.getElementById('status-box').style.display = 'none';
                    document.getElementById('root').style.display = 'block';
                });

                const unsubLogs = db.collection('houseLogs').orderBy('createdAt', 'desc').limit(50).onSnapshot(snap => {
                    setLogs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                const unsubTags = db.collection('houseTags').orderBy('name').onSnapshot(snap => {
                    setCustomTags(snap.docs.map(d => d.data().name));
                });

                return () => { unsubExp(); unsubLogs(); unsubTags(); };
            }, [user]);

            // Log Ekleme
            const addLog = (action, detail) => {
                db.collection('houseLogs').add({
                    user: sessionName || 'Bilinmeyen',
                    action: action,
                    detail: detail,
                    date: new Date().toLocaleString('tr-TR'),
                    createdAt: Date.now()
                });
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const nameInput = e.target.elements.name.value;
                if(nameInput) {
                    localStorage.setItem('deviceUser', nameInput);
                    setSessionName(nameInput);
                    setShowLogin(false);
                }
            };

            // Harcama Ekleme
            const addExpense = async (e) => {
                e.preventDefault();
                if(!amount) { alert("L√ºtfen tutar girin."); return; }
                
                // Eƒüer a√ßƒ±klama bo≈üsa, kategori adƒ±nƒ± a√ßƒ±klama yapmasƒ±n, bo≈ü kalsƒ±n veya kategori g√∂r√ºns√ºn
                const finalDesc = description || ""; 

                try {
                    await db.collection('houseExpenses').add({
                        category: category, // YENƒ∞: Kategori ayrƒ±
                        description: finalDesc, // YENƒ∞: A√ßƒ±klama ayrƒ±
                        amount: parseFloat(amount),
                        payer,
                        date: new Date(selectedDate).toLocaleDateString('tr-TR'),
                        dateIso: selectedDate,
                        createdAt: Date.now()
                    });
                    
                    addLog("Harcama Eklendi", `${payer} - [${category}] ${finalDesc} (${amount} TL)`);
                    setDescription('');
                    setAmount('');
                    setCategory('Diƒüer'); // Sƒ±fƒ±rla
                } catch(e) { alert("Hata: " + e.message); }
            };

            const deleteExpense = async (id, cat, desc, amt, who) => {
                if(confirm('Bu kayƒ±t silinsin mi?')) {
                    await db.collection('houseExpenses').doc(id).delete();
                    addLog("Harcama Silindi", `${who} - [${cat}] ${desc} (${amt} TL)`);
                }
            };

            const addNewTag = async () => {
                const newTag = prompt("Yeni kategori adƒ± (√ñrn: Taksi):");
                if (newTag) {
                    await db.collection('houseTags').add({ name: newTag });
                    addLog("Kategori Eklendi", newTag);
                }
            };

            // --- FILTRELEME VE HESAPLAMA ---
            const periodRange = getPeriodRange(viewDate);
            const allTags = [...DEFAULT_TAGS, ...customTags];

            // 1. D√∂nem Filtresi
            const expensesInPeriod = allExpenses.filter(ex => {
                if (!ex.dateIso) return false; 
                const exDate = new Date(ex.dateIso);
                return exDate >= periodRange.start && exDate <= periodRange.end;
            });

            // 2. Kullanƒ±cƒ± ve Kategori Filtresi
            const filteredExpenses = expensesInPeriod.filter(ex => {
                const userMatch = filterUser === 'HEPSI' ? true : ex.payer === filterUser;
                const catMatch = filterCategories.length === 0 ? true : filterCategories.includes(ex.category || 'Diƒüer');
                return userMatch && catMatch;
            });

            // Filtrelenmi≈ü Toplamlar (Ekranda g√∂sterilen listenin toplamƒ±)
            const filteredTotal = filteredExpenses.reduce((acc, curr) => acc + curr.amount, 0);

            // Genel Dengeler (Filtreden baƒüƒ±msƒ±z, o d√∂nemdeki bor√ß hesabƒ± i√ßin)
            const cihanTotal = expensesInPeriod.filter(e => e.payer === 'Cihan').reduce((a, b) => a + b.amount, 0);
            const bayramTotal = expensesInPeriod.filter(e => e.payer === 'Bayram').reduce((a, b) => a + b.amount, 0);
            const diff = (cihanTotal - bayramTotal) / 2;
            const fmt = (n) => new Intl.NumberFormat('tr-TR', {style:'currency', currency:'TRY'}).format(n);

            const isSettlementDay = new Date().getDate() === 21 && 
                                    new Date().getMonth() === viewDate.getMonth();

            // --- YILLIK √ñZET HESAPLAMA ---
            const calculateYearlyStats = () => {
                const stats = {};
                // T√ºm zamanlarƒ±n verisini tarƒ±yoruz
                allExpenses.forEach(ex => {
                    const d = new Date(ex.dateIso);
                    const monthKey = d.toLocaleString('tr-TR', { month: 'long', year: 'numeric' }); // √ñrn: Aralƒ±k 2024
                    
                    // Sƒ±ralama i√ßin sayƒ±sal anahtar
                    const sortKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

                    if (!stats[sortKey]) {
                        stats[sortKey] = { label: monthKey, total: 0, count: 0 };
                    }
                    stats[sortKey].total += ex.amount;
                    stats[sortKey].count += 1;
                });
                
                // Tarihe g√∂re sƒ±rala (Yeniden eskiye)
                return Object.entries(stats)
                    .sort((a, b) => b[0].localeCompare(a[0]))
                    .map(([key, val]) => val);
            };

            const toggleCategoryFilter = (tag) => {
                if (filterCategories.includes(tag)) {
                    setFilterCategories(filterCategories.filter(t => t !== tag));
                } else {
                    setFilterCategories([...filterCategories, tag]);
                }
            };

            // Login Modal
            if (showLogin) {
                return (
                    <div className="fixed inset-0 bg-slate-900 flex items-center justify-center p-4 z-50">
                        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                            <h2 className="text-xl font-bold mb-4">üëã Ho≈ü Geldin!</h2>
                            <p className="text-slate-500 mb-4 text-sm">Cihazƒ± kimin kullandƒ±ƒüƒ±nƒ± se√ß:</p>
                            <form onSubmit={handleLogin}>
                                <input name="name" type="text" placeholder="√ñrn: Cihan Telefon" className="w-full p-3 border rounded-lg mb-4" autoFocus />
                                <button className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">Kaydet</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto p-4 pb-20 space-y-4 font-sans text-slate-800">
                    
                    {/* √úST BAR */}
                    <div className="bg-white p-3 rounded-xl shadow border-l-4 border-blue-500 flex justify-between items-center">
                        <div>
                            <h1 className="text-lg font-bold">üè† Ev Giderleri</h1>
                            <div className="text-xs text-slate-400">üë§ {sessionName}</div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('yearly')} className={`text-xs px-2 py-1 rounded border ${view === 'yearly' ? 'bg-blue-600 text-white' : 'bg-slate-50'}`}>
                                üìÖ Yƒ±llƒ±k
                            </button>
                            <button onClick={() => setView(view === 'main' ? 'logs' : 'main')} className="text-2xl">
                                {view === 'main' ? 'üìú' : 'üè†'}
                            </button>
                        </div>
                    </div>

                    {/* --- YILLIK G√ñR√úN√úM --- */}
                    {view === 'yearly' && (
                        <div className="bg-white rounded-xl shadow p-4">
                            <h3 className="font-bold text-lg mb-4 border-b pb-2 flex justify-between">
                                üìÖ Yƒ±llƒ±k √ñzet
                                <button onClick={()=>setView('main')} className="text-xs bg-gray-200 px-2 rounded">Kapat</button>
                            </h3>
                            <div className="space-y-3">
                                {calculateYearlyStats().map((stat, idx) => (
                                    <div key={idx} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg border">
                                        <div>
                                            <div className="font-bold text-slate-700">{stat.label}</div>
                                            <div className="text-xs text-slate-400">{stat.count} harcama</div>
                                        </div>
                                        <div className="text-lg font-bold text-blue-600">{fmt(stat.total)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* --- LOG G√ñR√úN√úM√ú --- */}
                    {view === 'logs' && (
                        <div className="bg-white rounded-xl shadow p-4">
                            <h3 className="font-bold text-lg mb-4 border-b pb-2">üìú ƒ∞≈ülem Kayƒ±tlarƒ±</h3>
                            <div className="space-y-3 max-h-[70vh] overflow-y-auto">
                                {logs.map(log => (
                                    <div key={log.id} className="text-sm p-3 bg-slate-50 rounded-lg border">
                                        <div className="flex justify-between font-bold">
                                            <span className={log.action.includes('Sil') ? 'text-red-500':'text-blue-500'}>{log.action}</span>
                                            <span className="text-slate-400 text-xs">{log.date}</span>
                                        </div>
                                        <div className="mt-1">{log.detail}</div>
                                        <div className="text-xs text-slate-400 mt-1">Cihaz: {log.user}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* --- ANA G√ñR√úN√úM --- */}
                    {view === 'main' && (
                        <>
                            {/* D√ñNEM GEZƒ∞NTƒ∞Sƒ∞ */}
                            <div className="bg-slate-800 text-white p-3 rounded-xl flex justify-between items-center shadow-lg">
                                <button onClick={() => {
                                    const newDate = new Date(viewDate);
                                    newDate.setMonth(newDate.getMonth() - 1);
                                    setViewDate(newDate);
                                }} className="p-2 hover:bg-slate-700 rounded-lg">‚óÄ</button>
                                <div className="text-center">
                                    <div className="text-xs text-slate-400">D√∂nem</div>
                                    <div className="font-bold text-sm">{periodRange.label}</div>
                                </div>
                                <button onClick={() => {
                                    const newDate = new Date(viewDate);
                                    newDate.setMonth(newDate.getMonth() + 1);
                                    setViewDate(newDate);
                                }} className="p-2 hover:bg-slate-700 rounded-lg">‚ñ∂</button>
                            </div>

                            {/* √ñZET KARTLARI (Bor√ß Durumu) */}
                            <div className="bg-white p-4 rounded-xl shadow space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-50 p-2 rounded border text-center">
                                        <div className="text-xs text-slate-500">Cihan</div>
                                        <div className="font-bold">{fmt(cihanTotal)}</div>
                                    </div>
                                    <div className="bg-slate-50 p-2 rounded border text-center">
                                        <div className="text-xs text-slate-500">Bayram</div>
                                        <div className="font-bold">{fmt(bayramTotal)}</div>
                                    </div>
                                </div>
                                <div className="bg-slate-800 text-white p-3 rounded-xl text-center text-sm">
                                    {diff > 0 ? 
                                        <span>√ñdenmesi Gereken: <span className="font-bold text-orange-400">Bayram ‚ûî Cihan: {fmt(diff)}</span></span> :
                                     diff < 0 ?
                                        <span>√ñdenmesi Gereken: <span className="font-bold text-orange-400">Cihan ‚ûî Bayram: {fmt(Math.abs(diff))}</span></span> :
                                        <span className="text-green-400 font-bold">‚úÖ Bor√ß Yok, E≈üit!</span>
                                    }
                                </div>
                            </div>

                            {/* EKLEME FORMU */}
                            <form onSubmit={addExpense} className="bg-white p-4 rounded-xl shadow space-y-3 relative">
                                <h3 className="font-bold text-sm text-slate-700">Harcama Ekle</h3>
                                
                                {/* KATEGORƒ∞ SE√áƒ∞Mƒ∞ */}
                                <div className="mb-2">
                                    <label className="text-xs text-slate-400 mb-1 block">1. Kategori Se√ß:</label>
                                    <div className="flex flex-wrap gap-2">
                                        {allTags.map(tag => (
                                            <button 
                                                key={tag} 
                                                type="button" 
                                                onClick={() => setCategory(tag)}
                                                className={`px-2 py-1 text-xs rounded border transition ${category === tag ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                                            >
                                                {tag}
                                            </button>
                                        ))}
                                        <button type="button" onClick={addNewTag} className="px-2 py-1 text-xs bg-green-50 text-green-600 border border-green-200 font-bold">+ Ekle</button>
                                    </div>
                                </div>

                                {/* A√áIKLAMA Gƒ∞Rƒ∞≈ûƒ∞ */}
                                <div>
                                    <label className="text-xs text-slate-400 mb-1 block">2. A√ßƒ±klama (ƒ∞steƒüe baƒülƒ±):</label>
                                    <input type="text" placeholder="√ñrn: 2 Koli Yumurta" value={description} onChange={e=>setDescription(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                                </div>

                                <div className="flex gap-2">
                                    <div className="flex-1">
                                        <label className="text-xs text-slate-400 mb-1 block">3. Tutar:</label>
                                        <input type="number" placeholder="0.00" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full p-3 border rounded-lg" />
                                    </div>
                                    <div className="flex-1">
                                        <label className="text-xs text-slate-400 mb-1 block">4. Tarih:</label>
                                        <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full p-3 border rounded-lg bg-white" />
                                    </div>
                                </div>

                                <label className="text-xs text-slate-400 mb-1 block">5. √ñdeyen:</label>
                                <select value={payer} onChange={e=>setPayer(e.target.value)} className="w-full p-3 border rounded-lg bg-white mb-2">
                                    <option value="Cihan">Cihan √ñdedi</option>
                                    <option value="Bayram">Bayram √ñdedi</option>
                                </select>
                                
                                <button className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg">
                                    {category === 'Diƒüer' && !description ? 'L√ºtfen Bilgi Girin' : `‚ûï ${category} Ekle`}
                                </button>
                            </form>

                            {/* Lƒ∞STE VE Fƒ∞LTRELER */}
                            <div className="space-y-2 pb-10">
                                <div className="flex flex-col gap-2 bg-white p-3 rounded-xl shadow-sm border">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-bold text-sm text-slate-700">Filtrele</h3>
                                        <span className="text-xs font-bold text-blue-600">Se√ßili Toplam: {fmt(filteredTotal)}</span>
                                    </div>
                                    
                                    {/* Kategori Filtresi (√áoklu Se√ßim) */}
                                    <div className="flex flex-wrap gap-1 max-h-24 overflow-y-auto">
                                        {allTags.map(tag => (
                                            <button 
                                                key={tag} 
                                                onClick={() => toggleCategoryFilter(tag)}
                                                className={`px-2 py-1 text-[10px] rounded border transition ${filterCategories.includes(tag) ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-500'}`}
                                            >
                                                {tag}
                                            </button>
                                        ))}
                                        {filterCategories.length > 0 && <button onClick={()=>setFilterCategories([])} className="px-2 py-1 text-[10px] text-red-500 underline">Temizle</button>}
                                    </div>

                                    {/* Ki≈üi Filtresi */}
                                    <div className="flex bg-slate-100 rounded p-1 self-start">
                                        <button onClick={() => setFilterUser('HEPSI')} className={`px-2 py-1 text-xs rounded ${filterUser === 'HEPSI' ? 'bg-white shadow text-black' : 'text-slate-500'}`}>Hepsi</button>
                                        <button onClick={() => setFilterUser('Cihan')} className={`px-2 py-1 text-xs rounded ${filterUser === 'Cihan' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>Cihan</button>
                                        <button onClick={() => setFilterUser('Bayram')} className={`px-2 py-1 text-xs rounded ${filterUser === 'Bayram' ? 'bg-white shadow text-emerald-600' : 'text-slate-500'}`}>Bayram</button>
                                    </div>
                                </div>

                                {filteredExpenses.length === 0 ? 
                                    <div className="text-center py-8 text-gray-400 bg-white rounded-xl border border-dashed">
                                        Kayƒ±t bulunamadƒ±.
                                    </div> 
                                : filteredExpenses.map(ex => (
                                    <div key={ex.id} className="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-slate-50">
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <span className="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded text-[10px] font-bold border border-blue-100">
                                                    {ex.category || 'Diƒüer'}
                                                </span>
                                                <span className="font-bold text-slate-800 text-sm">{ex.description}</span>
                                            </div>
                                            <div className="text-xs text-slate-500 mt-0.5">{ex.date} ‚Ä¢ {ex.payer}</div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-slate-700">{fmt(ex.amount)}</span>
                                            <button onClick={()=>deleteExpense(ex.id, ex.category || 'Genel', ex.description, ex.amount, ex.payer)} className="text-slate-300 hover:text-red-500 text-lg p-1">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    } catch (err) {
        document.getElementById('status-box').style.display = 'block';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-message').innerHTML = 'HATA: ' + err.message;
    }
</script>

</body>
</html>
